{% extends 'base.html.twig' %}

{% block title %}Search{% endblock %}

{% block body %}
    <h2>Search for care</h2>
    {% include 'search-form.html.twig' with {
        searchForm: searchForm
    } only %}
    {% if searchResults %}
        {% if searchResults.matchedLocation %}
            {% set resultPluralized = searchResults.totalResults > 1 ? 'results' : 'result' %}
            {% set milePluralized = searchResults.searchRadius > 1 ? 'miles' : 'mile' %}
            <h4 class="mt-4">{{ searchResults.totalResults }} {{ resultPluralized }} within {{ searchResults.searchRadius }} {{ milePluralized }} of {{ searchResults.matchedLocation.title }}</h4>
            <div class="row">
                <div class="col-lg-6 order-lg-1 mb-4 mb-lg-0">
                    <div id="previewMap"
                         data-origin-latitude="{{ searchResults.matchedLocation.latitude }}"
                         data-origin-longitude="{{ searchResults.matchedLocation.longitude }}"
                         data-search-radius="{{ searchResults.searchRadius }}"
                    ></div>
                </div>
                <div class="col-lg-6 order-lg-0">
                    {% for clinic in searchResults.results %}
                        <div class="card clinic"
                             data-index="{{ loop.index }}"
                             data-latitude="{{ clinic.latitude }}"
                             data-longitude="{{ clinic.longitude }}"
                        >
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <h5 class="clinic-name">{{ clinic.name }}</h5>
                                    {% set distance = distance(searchResults.matchedLocation.latitude, searchResults.matchedLocation.longitude, clinic.latitude, clinic.longitude)|round %}
                                    <small class="clinic__mile-text">{{ distance }} {{ distance > 1 ? 'miles' : 'mile' }}</small>
                                </div>
                                {% if clinic.description %}
                                    <p>{{ clinic.description }}</p>
                                {% endif %}
                                {% if clinic.dataSource == "erinReed" %}
                                    <span class="badge text-bg-secondary">Informed Consent</span>
                                {% endif %}
                            </div>
                            <div class="card-footer d-flex justify-content-between align-items-center">
                                <small class="text-muted text-uppercase">Directions</small>
                                <div>
                                    <a type="button" class="btn btn-sm text-white bg-openstreetmaps" target="_blank" href="https://www.openstreetmap.org/directions?engine=fossgis_osrm_car&route={{ searchResults.matchedLocation.latitude }},{{ searchResults.matchedLocation.longitude }};{{ clinic.latitude }},{{ clinic.longitude }}">
                                        <i class="fa-solid fa-magnifying-glass"></i>
                                        Open Street Maps
                                    </a>
                                    <a type="button" class="btn btn-sm text-white bg-googlemaps" target="_blank" href="https://www.google.com/maps/dir/?api=1&origin={{ searchResults.matchedLocation.latitude }},{{ searchResults.matchedLocation.longitude }}&destination={{ clinic.latitude }},{{ clinic.longitude }}&travelmode=driving">
                                        <i class="fa-brands fa-google"></i>
                                        Google Maps
                                    </a>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            <div class="row justify-content-center mt-4">
                {% include 'pagination.html.twig' with {
                    currentFilters: pageFilters,
                    currentPage: searchResults.currentPage,
                    paginationPath: "app_search",
                    lastPage: searchResults.totalPages,
                    showAlwaysFirstAndLast: true
                } only %}
            </div>
        {% else %}
            <p class="mt-4">No {{ pageFilters.searchType == 'city' ? 'cities' : 'postal codes' }} found matching "{{ pageFilters.searchText }}"</p>
        {% endif %}
    {% endif %}
{% endblock %}

{% block stylesheets %}
    {{ encore_entry_link_tags('search') }}
{% endblock %}

{% block scripts %}
    {{ encore_entry_script_tags('search') }}
{% endblock %}